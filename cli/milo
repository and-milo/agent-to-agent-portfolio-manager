#!/usr/bin/env python3

import argparse
import json
import os
import sys
import urllib.parse
import urllib.request
import urllib.error


def parse_json_arg(value, name):
    if value is None:
        return None
    try:
        return json.loads(value)
    except json.JSONDecodeError as exc:
        raise SystemExit(f"Invalid JSON for {name}: {exc}")


def parse_bool(value, name):
    if value is None:
        return None
    if value.lower() in {"true", "1", "yes"}:
        return True
    if value.lower() in {"false", "0", "no"}:
        return False
    raise SystemExit(f"Invalid boolean for {name}: {value}")


def build_url(base_url, path, params=None):
    base_url = base_url.rstrip("/")
    url = f"{base_url}{path}"
    if params:
        filtered = {k: v for k, v in params.items() if v is not None}
        if filtered:
            url = f"{url}?{urllib.parse.urlencode(filtered)}"
    return url


def request(method, url, api_key, body=None):
    headers = {"X-API-Key": api_key}
    data = None
    if body is not None:
        headers["Content-Type"] = "application/json"
        data = json.dumps(body).encode("utf-8")

    req = urllib.request.Request(url, data=data, headers=headers, method=method)
    try:
        with urllib.request.urlopen(req) as resp:
            sys.stdout.write(resp.read().decode("utf-8"))
    except urllib.error.HTTPError as exc:
        sys.stderr.write(exc.read().decode("utf-8"))
        sys.exit(exc.code)


def main():
    parser = argparse.ArgumentParser(
        description="Reference CLI for the &milo 3rd-party API"
    )
    parser.add_argument("--base-url", help="API base URL (or set MILO_BASE_URL)")
    parser.add_argument("--api-key", help="API key (or set MILO_API_KEY)")

    subparsers = parser.add_subparsers(dest="command", required=True)

    create_user = subparsers.add_parser("create-user")
    create_user.add_argument("--signup-wallet", required=True)

    diary_logs = subparsers.add_parser("diary-logs")
    diary_logs.add_argument("--user-id", required=True)
    diary_logs.add_argument("--page", type=int)
    diary_logs.add_argument("--page-size", type=int)

    executed = subparsers.add_parser("executed-transactions")
    executed.add_argument("--wallet-id", required=True)
    executed.add_argument("--tx-type")
    executed.add_argument("--token")
    executed.add_argument("--min-usd-value")
    executed.add_argument("--since")
    executed.add_argument("--until")

    holdings = subparsers.add_parser("holdings")
    holdings.add_argument("--wallet-id", required=True)

    positions = subparsers.add_parser("positions")
    positions.add_argument("--user-id", required=True)
    positions.add_argument("--status", default="active")

    transactions = subparsers.add_parser("transactions")
    transactions.add_argument("--wallet-id", required=True)
    transactions.add_argument("--page", type=int)
    transactions.add_argument("--page-size", type=int)

    auto_trade = subparsers.add_parser("auto-trade-settings")
    auto_trade.add_argument("--user-id", required=True)
    auto_trade.add_argument("--risk-tolerance", required=True)
    auto_trade.add_argument("--strategy", required=True)
    auto_trade.add_argument("--allocation-json")
    auto_trade.add_argument("--instructions")
    auto_trade.add_argument("--allow-list-json")
    auto_trade.add_argument("--is-active")

    conversation = subparsers.add_parser("conversation")
    conversation.add_argument("--conversation-id", required=True)

    send_message = subparsers.add_parser("send-message")
    send_message.add_argument("--conversation-id", required=True)
    send_message.add_argument("--role", default="user")
    send_message.add_argument("--content", required=True)

    args = parser.parse_args()

    base_url = args.base_url or os.getenv("MILO_BASE_URL")
    api_key = args.api_key or os.getenv("MILO_API_KEY")

    if not base_url:
        raise SystemExit("Missing base URL. Set --base-url or MILO_BASE_URL.")
    if not api_key:
        raise SystemExit("Missing API key. Set --api-key or MILO_API_KEY.")

    if args.command == "create-user":
        url = build_url(base_url, "/api/v1/users")
        body = {"signupWallet": args.signup_wallet}
        request("POST", url, api_key, body)
        return

    if args.command == "diary-logs":
        url = build_url(
            base_url,
            f"/api/v1/users/{args.user_id}/diary-logs",
            {"page": args.page, "pageSize": args.page_size},
        )
        request("GET", url, api_key)
        return

    if args.command == "executed-transactions":
        url = build_url(
            base_url,
            f"/api/v1/wallets/{args.wallet_id}/executed-transactions",
            {
                "txType": args.tx_type,
                "token": args.token,
                "minUsdValue": args.min_usd_value,
                "since": args.since,
                "until": args.until,
            },
        )
        request("GET", url, api_key)
        return

    if args.command == "holdings":
        url = build_url(base_url, f"/api/v1/wallets/{args.wallet_id}/holdings")
        request("GET", url, api_key)
        return

    if args.command == "positions":
        url = build_url(
            base_url,
            f"/api/v1/users/{args.user_id}/positions",
            {"status": args.status},
        )
        request("GET", url, api_key)
        return

    if args.command == "transactions":
        url = build_url(
            base_url,
            f"/api/v1/wallets/{args.wallet_id}/transactions",
            {"page": args.page, "pageSize": args.page_size},
        )
        request("GET", url, api_key)
        return

    if args.command == "auto-trade-settings":
        allocation = parse_json_arg(args.allocation_json, "allocation-json")
        allow_list = parse_json_arg(args.allow_list_json, "allow-list-json")
        is_active = parse_bool(args.is_active, "is-active")
        body = {
            "riskTolerance": args.risk_tolerance,
            "strategy": args.strategy,
            "allocation": allocation,
            "instructions": args.instructions,
            "allowList": allow_list,
            "isActive": is_active,
        }
        url = build_url(
            base_url, f"/api/v1/users/{args.user_id}/auto-trade-settings"
        )
        request("PATCH", url, api_key, body)
        return

    if args.command == "conversation":
        url = build_url(base_url, f"/api/v1/conversations/{args.conversation_id}")
        request("GET", url, api_key)
        return

    if args.command == "send-message":
        body = {
            "conversationId": args.conversation_id,
            "role": args.role,
            "content": args.content,
        }
        url = build_url(base_url, "/api/v1/messages")
        request("POST", url, api_key, body)
        return


if __name__ == "__main__":
    main()
